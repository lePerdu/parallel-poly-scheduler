# Parallel and Distributed Computing Project

# We use C++11
LOCAL_CXXFLAGS := -std=c++11

# Default warnings
CXXFLAGS ?= -Wall

MPICXX ?= mpiCC

# MPI-specific flags
MPI_CXXFLAGS ?=
MPI_LDFLAGS ?=

# Combine them for simplicity
LOCAL_CXXFLAGS += $(MPI_CXXFLAGS)
LOCAL_LDFLAGS += $(MPI_LDFLAGS)

ifdef PRODUCTION
# Turn off asserts and turn on optimizations
LOCAL_CXXFLAGS += -DNDEBUG -O3
else
LOCAL_CXXFLAGS += -g -Og
endif

# JSON library includes
NLOHMANN_JSON := nlohmann_json
LOCAL_CXXFLAGS += -I$(NLOHMANN_JSON)/single_include

SRC := src
BUILD := build
BIN := bin
TEST := test

TARGET := $(BIN)/parallel_scheduler

SOURCES := $(wildcard $(SRC)/*.cpp)
OBJECTS := $(patsubst $(SRC)/%.cpp,$(BUILD)/%.o,$(SOURCES))

CLANG_FORMAT := clang-format

all: $(TARGET)

$(TARGET): $(OBJECTS) | $(BIN)
	$(MPICXX) $(LOCAL_LDFLAGS) $(LDFLAGS) -o $@ $^

$(BUILD)/%.o: $(SRC)/%.cpp | $(BUILD)
	$(MPICXX) $(LOCAL_CXXFLAGS) $(CXXFLAGS) -MMD -c -o $@ $<

$(BUILD):
	@mkdir -p $@

$(BIN):
	@mkdir -p $@

format:
	$(CLANG_FORMAT) -i $(SRC)/* $(TEST)/*

clean:
	rm -rf $(BUILD) $(BIN)

.PHONY: all format clean

# Include dependency files generated by the compiler (see -MMD option)
-include $(BUILD)/*.d
